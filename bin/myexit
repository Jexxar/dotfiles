#!/usr/bin/env bash
set -eu

if [ -f "$HOME/bin/mycommon" ]; then
    . "$HOME/bin/mycommon"
fi

# Exit wm if possible.
function do_this_exit() {
    # Only works if X is running.
    if ! is_running_X ; then
        log "X server is not running";
        return 0;
    fi

    # Screen must be unlocked first.
    locked && return 0;
    
    dunstctl stop

    # Stop this session and daemon running processes.
    stop_it "polkit-gnome-authentication-agent-1" "stop"
    stop_it "gnome-keyring-daemon" "stop"
    stop_it "gnome-settings-daemon" "stop"
    stop_it "gnome-screensaver" "stop"
    stop_it "polkit-mate-authentication-agent-1" "stop"
    stop_it "mate-settings-daemon" "stop"
    stop_it "mate-power-manager" "stop"
    stop_it "mate-volume-control-applet" "stop"
    stop_it "mate-screensaver" "stop"
    stop_it "cinnamon-screensaver" "stop"
    stop_it "xscreensaver" "stop"
    stop_it "xautolock" "stop"
    stop_it "redshift-gtk" "stop"
    stop_it "redshift" "stop"
    stop_it "mylightson" "stop"
    stop_it "mywallchng" "stop"
    stop_it "tint2" "stop"
    stop_it "compton" "stop"

    log "Exiting now..."
    openbox --exit;

    killall openbox;

    # dbus-launch cleanup
    pkill -u $USER -t `tty | cut -d '/' -f 3,4` dbus-launch

    return 0
}

function do_test() {
    if is_running_X ; then
        log "X is running"
    else
        log "X server down"
    fi
    
    if [ `locked "debug"` ]; then
        log "Screen already locked"
    else
        log "Screen not locked"
    fi
    
    if [ `pkill -0 --exact dunst` ]; then
        log "dunst found"
    else
        log "dunst not found"
    fi

    stop_it "polkit-gnome-authentication-agent-1" "debug"
    stop_it "gnome-keyring-daemon" "debug"
    stop_it "gnome-settings-daemon" "debug"
    stop_it "gnome-screensaver" "debug"
    stop_it "polkit-mate-authentication-agent-1" "debug"
    stop_it "mate-settings-daemon" "debug"
    stop_it "mate-power-manager" "debug"
    stop_it "mate-volume-control-applet" "debug"
    stop_it "mate-screensaver" "debug"
    stop_it "cinnamon-screensaver" "debug"
    stop_it "xscreensaver" "debug"
    stop_it "xautolock" "debug"
    stop_it "caffeine-indicator" "debug"
    stop_it "caffeine" "debug"
    stop_it "redshift-gtk" "debug"
    stop_it "redshift" "debug"
    stop_it "mylightson" "debug"
    stop_it "mywallchng" "debug"
    stop_it "tint2" "debug"
    stop_it "compton" "debug"

    log "Exiting now..."
    log "openbox --exit;"
    log "kilall openbox;"
    log "pkill -u $USER -t `tty | cut -d '/' -f 3,4` dbus-launch"
    
    return 0
}


cmd=${1:-exit}

case "$cmd" in
    exit)
        do_this_exit
        ;;  
    debug)
        do_test
        ;;
    *)
        log "Unrecognized option: $1"
esac
