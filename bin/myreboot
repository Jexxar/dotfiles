#!/usr/bin/env bash
set -eu

if [ -f "$HOME/bin/mycommon" ]; then
    . "$HOME/bin/mycommon"
fi

# This script is intended to be run as the main reboot script for this installation.
function do_reboot() {
    if is_running_X ; then
        if locked ; then
            return 0
        fi
        if auth_user; then
            if systemctl_ok; then
                systemctl reboot &
                exit 0
            fi
            if can_reboot; then
                dbus_reboot
                exit 0
            fi
            if shutdown_ok; then
                shutdown -r now &
                exit 0
            fi
            if init_ok; then
                init 6 &
                exit 0
            fi
        fi
    else
        if auth_user; then
            if systemctl_ok; then
                systemctl reboot &
                exit 0
            fi
            if shutdown_ok; then
                shutdown -r now &
                exit 0
            fi
            if init_ok; then
                init 6 &
                exit 0
            fi
        fi
    fi
    
}

function do_test() {
    if is_running_X ; then
        log "X is running"
        if locked "debug" ; then
            log "Screen locked"
        else
            log "Screen not locked"
        fi
        if auth_user; then
            log "user $USER has polkit binding to reboot"
            if systemctl_ok; then
                log "can use: systemctl reboot"
            fi
            if can_reboot; then
                log "can use: dbus logind to reboot"
            fi
            if shutdown_ok; then
                log "can use: shutdown -r now"
            fi
            if init_ok; then
                log "can use: init 6"
            fi
        fi
    else
        log "X is not running"
        if auth_user; then
            log "user $USER has polkit binding to reboot"
            if systemctl_ok; then
                log "can use: systemctl reboot"
            fi
            if shutdown_ok; then
                log "can use: shutdown -r now"
            fi
            if init_ok; then
                log "can use: init 6"
            fi
        fi
    fi
    return 0
}

cmd=${1:-reboot}

case "$cmd" in
    reboot)
        log "reboot now..."
        do_reboot
    ;;
    debug)
        do_test
    ;;
    *)
        log "Unrecognized option: $1"
esac
