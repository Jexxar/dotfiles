#!/bin/bash
set -eu

if [ -f "$HOME/bin/mylog" ]; then
    . "$HOME/bin/mylog"
fi

# This script is intended to be run as the main reboot script for this installation.
cmd=${1:-reboot}

# Return 0 if systemctl is found.
function systemctl_ok() {
    [ $(which systemctl) ] && return 0
    return 1
}

# Return 0 if shutdown is found.
function shutdown_ok() {
    [ $(which shutdown) ] && return 0
    return 1
}

# Return 0 if init is found.
function init_ok() {
    [ $(which init) ] && return 0
    return 1
}

function do_reboot() {
    if [ systemctl_ok ]; then
        systemctl reboot
    fi
    if [ shutdown_ok ]; then
        shutdown -r now
    fi
    if [ init_ok ]; then
        init 6
    fi
}

function do_test() {
    if [ systemctl_ok ]; then
        log "using: systemctl reboot"
        return 0
    fi
    if [ shutdown_ok ]; then
        log "using: shutdown -r now"
        return 0
    fi
    if [ init_ok ]; then
        log "using: init 6"
        return 0
    fi
}

case "$cmd" in
    reboot)
        log "reboot now..."
        do_reboot
        ;;
    debug)
        do_test
        ;;
    *)
        log "Unrecognized option: $1"
esac
