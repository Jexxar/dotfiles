#!/usr/bin/env bash

# common functions for pipe menus

# required awk, bc

function findJPGPath(){
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo ""
        return 1
    fi
    local iconJPG="${2}.jpg"
    cd "${1}" 
    find . -name "${iconJPG}" | grep "16" | cut -c 2- | tail -n 1
    return 0
}

function findPNGPath(){
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo ""
        return 1
    fi
    local iconPNG="${2}.png"
    cd "${1}" 
    find . -name "${iconPNG}" | grep "16" | cut -c 2- | tail -n 1
    return 0
}

function findSVGPath(){
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo ""
        return 1
    fi
    local iconSVG="${2}.svg"
    cd "${1}" 
    find . -name "${iconSVG}" | cut -c 2- | tail -n 1
    return 0
}

function findIconThemeName(){
    local tn=""
    tn=$(gsettings get org.mate.interface icon-theme | tr -d "'")
    [ -z "$tn" ] && tn=$(gsettings get org.gnome.desktop.interface icon-theme | tr -d "'")
    echo "$tn"
    return 0
}

function findIconThemePath(){
    if [ -z "$1" ]; then
        echo ""
        return 1
    fi
    local tn="$1"
    local tp=""
    tp="/usr/share/icons/$tn"
    
    if [ -d "$tp" ]; then
        echo "$tp"
        return 0
    else
        tp="$HOME/.icons/$tn"
        if [ -d "$tp" ]; then
            echo "$tp"
            return 0
        fi
    fi
    echo ""
    return 1
}

function FindIconPath(){
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo ""
        return 1
    fi
    
    local tp="$2"
    local nip=""
    
    nip=$(findSVGPath "$tp" "${1}")
    [ -z "$nip" ] && nip=$(findPNGPath "$tp" "${1}")
    [ -z "$nip" ] && nip=$(findJPGPath "$tp" "${1}")
    if [ -z "$nip" ]; then
        echo ""
        return 1
    fi
    
    echo "$tp$nip"
    return 0
}

function FallbackiconPath(){
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo ""
        return 1
    fi
    
    local tp="$2"
    local seaDirs=( $(grep "nherit" "$tp/index.theme" | cut -d"=" -f2 | xargs -d ",") )
    local tp=""
    local iconPath=""
    
    for i in "${seaDirs[@]}"; do
        tp=$(findIconThemePath "$i");
        iconPath=$(FindIconPath "$1" "$tp");
        #echo "o i = $i e o tp = $tp e o iconName=$1  e o iconPath = $iconPath"
        if [ ! -z "$iconPath" ]; then
            echo "$iconPath"
            return 0
        fi
    done
    echo ""
    return 1
}

function iconPath(){
    if [ -z "$1" ]; then
        echo ""
        return 1
    fi
    
    local themePath=""
    local iconPath=""
    local themeName=""

    themeName=$(findIconThemeName)
    themePath=$(findIconThemePath "$themeName")
    
    if [ -z "$themePath" ]; then
        echo ""
        return 1
    fi
    
    iconPath=$(FindIconPath "$1" "$themePath");
    
    if [ -z "$iconPath" ]; then
        iconPath=$(FallbackiconPath "$1" "$themePath")
        if [ -z "$iconPath" ]; then
            echo ""
            return 1
        fi
    fi
    
    echo "$iconPath"
    return 0
}

test -f ${XDG_CONFIG_HOME:-~/.config}/user-dirs.dirs && source ${XDG_CONFIG_HOME:-~/.config}/user-dirs.dirs