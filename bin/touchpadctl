#!/bin/bash
## $1 = "add" / "remove"
## $2 = %k from udev

function usage() {
    echo "Usage: $0 [Options]"
    echo "       "
    echo "Purpose: enable|disable Touchpad when mouse is plugged"
    echo "       "
    echo "Options"
    echo "-h: Show this help"
    echo "-d: Disable touchpad"
    echo "-e: Enable touchpad"
    echo "--disable: Disable touchpad"
    echo "--enable: Enable touchpad"
    return 0;
}

# Main
if [ $# -eq 0 ] ; then
    usage ;
    /usr/bin/logger -t Touchpadctl -- "No parameters."
    exit 0
fi

# Option strings
SHORT=":d::e::h"
LONG=":disable,enable,help"

# Read the options
OPTS=$(getopt --options $SHORT --long $LONG --name "$0" -- "$@")
if [ $? -ne 0 ] ; then
    usage ;
    /usr/bin/logger -t Touchpadctl -- "Wrong parameters.[ $* ]"
    exit 0
fi

# Obtain user list
USERLIST=$(w -h | cut -d' ' -f1 | sort | uniq)
for CUR_USER in ${USERLIST}; do
    CUR_USER_XAUTH="$(sudo -Hiu "${CUR_USER}" env | grep -e "^HOME=" | cut -d'=' -f2)/.Xauthority"
    ## Can't find a way to get another users DISPLAY variable from an isolated root environment. Have to set it manually.
    CUR_USER_DISPL="$(sudo -Hiu "${CUR_USER}" env | grep -e "^DISPLAY=" | cut -d'=' -f2)"
    [ -z "$CUR_USER_DISPL" ] && CUR_USER_DISPL=":0"
    
    export XAUTHORITY="${CUR_USER_XAUTH}"
    export DISPLAY="${CUR_USER_DISPL}"
    
    # Check running X
    if ! xset q &>/dev/null; then
        /usr/bin/logger -t Touchpadctl -- "Xserver is not running."
        exit 0
    fi
    
    if [ -f "${CUR_USER_XAUTH}" ]; then
        declare -i ID
        ID=$(/usr/bin/xinput list | \egrep -Eo 'Touchpad\s*id\=[0-9]{1,2}' | \egrep -Eo '[0-9]{1,2}')''
        declare -i STATE
        STATE=$(/usr/bin/xinput list-props $ID | \grep 'Device Enabled' | \awk '{print $4}')
        
        case "$1" in
            -d | --disable )
                if [ $STATE -eq 1 ]; then
                    /usr/bin/xinput disable $ID
                    /usr/bin/logger -t Touchpadctl -- "USB mouse plugged. Disabling touchpad for $CUR_USER. ($XAUTHORITY - $DISPLAY)"
                fi
            ;;
            -e | --enable )
                xinput list | \egrep -Eo '[Mm]ouse\s*id\=[0-9]{1,2}' | \egrep -Eo '[0-9]{1,2}' &>/dev/null
                if [ $? -eq 0 ] ; then
                    /usr/bin/logger -t Touchpadctl -- "Additional external mice found. Touchpad not enabled for $CUR_USER. ($XAUTHORITY - $DISPLAY)"
                    exit 0
                fi
                if [ $STATE -eq 0 ]; then
                    /usr/bin/xinput enable $ID
                    /usr/bin/logger -t Touchpadctl -- "No additional external mice found. Enabling touchpad for $CUR_USER. ($XAUTHORITY - $DISPLAY)"
                else
                    /usr/bin/logger -t Touchpadctl -- "Touchpad already enabled for $CUR_USER. ($XAUTHORITY - $DISPLAY)"
                fi
            ;;
            *)  usage; exit;;
        esac
    fi
done
