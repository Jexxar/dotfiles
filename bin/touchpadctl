#!/usr/bin/env bash
## $1 = "add" / "remove"
## $2 = %k from udev
set -eu

function usage() {
    echo "Usage: $(basename $0) [Options]"
    echo "       "
    echo "Purpose: To enable or disable Touchpad"
    echo "       "
    echo "Options"
    echo "-a | --auto : Disable/enable touchpad depending on other pointer attach"
    echo "-h | --help : Show this help"
    echo "-d | --disable: Disable touchpad"
    echo "-e | --enable: Enable touchpad"
    return 0;
}

function touch_hnd_noX(){
    local base_dir="/sys/bus/serio/drivers/psmouse"
    local device_id="serio1"

    case "$1" in
        -d | --disable)
            echo -n manual > $base_dir/bind_mode && /usr/bin/logger -t Touchpadctl -- "Disabling the touchpad" || /usr/bin/logger -t Touchpadctl -- "Cannot disable touchpad"
            echo -n $device_id > $base_dir/unbind 2>/dev/null || true
        ;;
        -e | --enable)
            echo -n auto > $base_dir/bind_mode && /usr/bin/logger -t Touchpadctl -- "Enabling the touchpad" || /usr/bin/logger -t Touchpadctl -- "Cannot enable touchpad"
        ;;
        *)  usage
            exit 0
        ;;
    esac
}

function xinput_disable_touch(){
    local t_id=$1
    local t_st=$2
    local usr=$3
    if [ $t_st -ne 0 ]; then
        /usr/bin/xinput disable $t_id
        /usr/bin/logger -t Touchpadctl -- "Disabling touchpad for $usr. ($XAUTHORITY - $DISPLAY)"
    else
        /usr/bin/logger -t Touchpadctl -- "Touchpad already disabled for $usr. ($XAUTHORITY - $DISPLAY)"
    fi
}

function xinput_enable_touch(){
    local t_id=$1
    local t_st=$2
    local usr=$3
    if [ $t_st -eq 0 ]; then
        /usr/bin/xinput enable $t_id
        /usr/bin/logger -t Touchpadctl -- "Enabling touchpad for $usr. ($XAUTHORITY - $DISPLAY)"
    else
        /usr/bin/logger -t Touchpadctl -- "Touchpad already enabled for $usr. ($XAUTHORITY - $DISPLAY)"
    fi
}

function touch_hnd_X(){
    local usr="$2"
    local touch_id=0
    local touch_stt=0
    local mouse_id=0
    local mouse_stt=0
    
    touch_id=$(/usr/bin/xinput list | \egrep -iEo 'Touchpad\s*id\=[0-9]{1,2}' | \egrep -Eo '[0-9]{1,2}')
    [ $? -ne 0 ] && touch_id=0 && /usr/bin/logger -t Touchpadctl -- "Touchpad device not found. $usr. ($XAUTHORITY - $DISPLAY)" && return 0

    touch_stt=$(/usr/bin/xinput list-props $touch_id | \grep 'Device Enabled' | \awk '{print $4}')
    [ $? -ne 0 ] && touch_stt=0
    
    case "$1" in
        -a | --auto )
            mouse_id="$(xinput list | grep -iv 'touchpad\|control\|virtual core\|core XTEST' | grep 'slave  pointer' | \egrep -iEo '*id\=[0-9]{1,2}' | \egrep -Eo '[0-9]{1,2}' | tail -n1)"
            [ $? -ne 0 ] && mouse_id=0 && /usr/bin/logger -t Touchpadctl -- "Mouse/Pointer device not found. $usr. ($XAUTHORITY - $DISPLAY)" && return 0
            mouse_stt=$(/usr/bin/xinput list-props $mouse_id | \grep 'Device Enabled' | \awk '{print $4}')
            [ $? -ne 0 ] && mouse_stt=0;
            if [ $mouse_id -ne 0 ] && [ $mouse_stt -ne 0 ]; then
                xinput_disable_touch "$touch_id" "$touch_stt" "$usr"
            else
                xinput_enable_touch "$touch_id" "$touch_stt" "$usr"
            fi
        ;;
        -d | --disable )
            xinput_disable_touch "$touch_id" "$touch_stt" "$usr"
        ;;
        -e | --enable )
            xinput_enable_touch "$touch_id" "$touch_stt" "$usr"
        ;;
        *)  usage
            exit 0
        ;;
    esac
}

function main(){
    if [ $# -eq 0 ]; then
        usage
        exit 1
    fi
    
    local user_list
    local user_id
    
    user_list="$(w -h | cut -d' ' -f1 | sort | uniq)"
    user_id="$(id -u)"

    if [ $user_id -eq 0 ]; then
        if xset q &>/dev/null; then
            /usr/bin/logger -t Touchpadctl -- "Xserver is running."
            touch_hnd_X "$1" "root"
        fi
        exit 0
    fi
    
    for u in ${user_list}; do
        ## Can't find a way to get another users DISPLAY variable from an isolated root environment. Have to set it manually.
        displ="$(sudo -Hiu "${u}" env | grep -e "^DISPLAY=" | cut -d'=' -f2)"
        [ -z "$displ" ] && displ=":0"
        export XAUTHORITY="$(sudo -Hiu "${u}" env | grep -e "^HOME=" | cut -d'=' -f2)/.Xauthority"
        export DISPLAY="${displ}"
        if [ -f "${XAUTHORITY}" ]; then
            # Check running X
            if xset q &>/dev/null; then
                /usr/bin/logger -t Touchpadctl -- "Xserver is running."
                touch_hnd_X "$1" "$u"
            #else
            #    /usr/bin/logger -t Touchpadctl -- "Xserver is not running."
            #    touch_hnd_noX "$1" "$u"
            fi
        fi
    done
}

main "$@"
