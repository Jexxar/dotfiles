#!/usr/bin/env bash

if [ -f "$HOME/bin/mycommon" ]; then
    . "$HOME/bin/mycommon"
fi

function change_wallpaper(){
    local old_IFS=$IFS
    IFS=$'\n'
    local WallDir="${XDG_PICTURES_DIR:-$HOME/Imagens}/Wallpaper"
    local WallList=( `find "$WallDir" -type f -iregex ".*/.*[.]\(jpe?g\|png\|gif\|bmp\)"` )
    IFS=$old_IFS
    local MaxFiles=${#WallList[@]}
    local LastFile="$WallDir/.last"
    if [ -f "$LastFile" ]; then 
        let CurrIndex="`cat "$LastFile"` + 1"
        if [ $CurrIndex -ge $MaxFiles ]; then
            let CurrIndex=1
        fi
    else
        let CurrIndex=1
    fi
    local number
    let number=$CurrIndex
    echo $number > "$WallDir"/.last
    nitrogen --set-scaled --save "${WallList[$number]}"
    log "Wallpaper changed to: ${WallList[$number]}"
}

function main(){
    log "=====[ mywallchng started current PID=$$ ]====="
    if ! is_running_X ; then
        log "No X server at \$DISPLAY [$DISPLAY]" >&2
        exit 0
    fi
    kill_older
    nitrogen --restore
    snore 0.2
    while is_running_X ; do 
        if [ -z "$DISPLAY" ]; then
            DISPLAY=:0.0
        fi
        snore 420;
        change_wallpaper;
    done;   
}

main
