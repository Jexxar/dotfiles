#!/usr/bin/env bash
set -eu

if [ -f "$HOME/bin/mycommon" ]; then
    . "$HOME/bin/mycommon"
fi

# This script is intended to be run as the main shutdown script for this installation.

function do_shutdown() {
    if is_running_X ; then
        if locked ; then
            return 0
        fi
        if auth_user; then
            if systemctl_ok; then
                systemctl poweroff &
                exit 0
            fi
            if can_poweroff; then
                dbus_poweroff
                exit 0
            fi
        fi
    else
        if auth_user; then
            if systemctl_ok; then
                systemctl poweroff &
                exit 0
            fi
            if shutdown_ok; then
                shutdown -h now
            fi
            if init_ok; then
                init 0
            fi
        fi
    fi
}

function do_test() {
    if is_running_X ; then
        log "X is running"
        if locked "debug" ; then
            log "Screen locked"
        else
            log "Screen not locked"
        fi
        if auth_user; then
            log "user $USER has polkit binding to poweroff"
            if systemctl_ok; then
                log "can use: systemctl poweroff"
            fi
            if can_poweroff; then
                log "can use: dbus logind to poweroff"
            fi
            if shutdown_ok; then
                log "can use: shutdown -h now"
            fi
            if init_ok; then
                log "can use: init 0"
            fi
        fi
    else
        log "X is not running"
        if auth_user; then
            log "user $USER has polkit binding to poweroff"
            if systemctl_ok; then
                log "can use: systemctl poweroff"
            fi
            if shutdown_ok; then
                log "can use: shutdown -h now"
            fi
            if init_ok; then
                log "can use: init 0"
            fi
        fi
    fi
    return 0
}

cmd=${1:-down}

case "$cmd" in
    down)
        log "shutdown now..."
        do_shutdown
    ;;
    debug)
        do_test
    ;;
    *)
        log "Unrecognized option: $1"
esac
