#!/usr/bin/env bash
set -eu

if [ -f "$HOME/bin/mycommon" ]; then
    . "$HOME/bin/mycommon"
fi

# This script is intended to be run as the main suspend script for this installation.

function do_suspend() {
    if is_running_X ; then
        if locked ; then
            return 0
        fi
        if auth_user; then
            if systemctl_ok; then
                systemctl suspend &
                exit 0
            fi
            if can_suspend; then
                dbus_suspend
                exit 0
            fi
        fi
    else
        if auth_user; then
            if systemctl_ok; then
                systemctl suspend &
                exit 0
            fi
        fi
    fi
}

function do_test() {
    if is_running_X ; then
        log "X is running"
        if locked "debug" ; then
            log "Screen locked"
        else
            log "Screen not locked"
        fi
        if auth_user; then
            log "user $USER has polkit binding to suspend"
            if systemctl_ok; then
                log "using: systemctl suspend"
                return 0
            fi
            if can_suspend; then
                log "using: dbus logind to suspend"
                return 0
            fi
        fi
    else
        log "X is not running"
        if auth_user; then
            log "user $USER has polkit binding to suspend"
            if systemctl_ok; then
                log "using: systemctl suspend"
                return 0
            fi
        fi
    fi
    return 0
}

cmd=${1:-suspend}

case "$cmd" in
    suspend)
        log "suspend now..."
        do_suspend
    ;;
    debug)
        do_test
    ;;
    *)
        log "Unrecognized option: $1"
esac
