#!/usr/bin/env bash
set -eu

if [ -f "$HOME/bin/mylog" ]; then
    . "$HOME/bin/mylog"
fi

# This script is intended to be run as the main notifier script for this installation.
cmd=${1:-notify}

function is_running_X(){
    xset q &>/dev/null && return 0;
    return 1
}

# Is the screen already locked?
function locked() {
    local DebugMode=${1:-no}
    ps f -u "$USER" -o pid,%cpu,%mem,bsdtime,command  | grep -v "grep" | grep "i3lock" &>/dev/null
    if [ $? -eq 0 ]; then
        if [ "$DebugMode" = "debug" ]; then
            log "i3lock found and active"
        fi
        return 0;
    fi
    ps f -u "$USER" -o pid,%cpu,%mem,bsdtime,command  | grep -v "grep" | grep "mate-screensaver-dialog" &>/dev/null
    if [ $? -eq 0 ]; then
        if [ "$DebugMode" = "debug" ]; then
            log "mate-screensaver-dialog found and active"
        fi
        return 0;
    fi
    ps f -u "$USER" -o pid,%cpu,%mem,bsdtime,command  | grep -v "grep" | grep "cinnamon-screensaver-pam-helper" &>/dev/null
    if [ $? -eq 0 ]; then
        if [ "$DebugMode" = "debug" ]; then
            log "cinnamon-screensaver-pam-helper found and active"
        fi
        return 0;
    fi
    ps f -u "$USER" -o pid,%cpu,%mem,bsdtime,command  | grep -v "grep" | grep "slimlock" &>/dev/null 
    if [ $? -eq 0 ]; then
        if [ "$DebugMode" = "debug" ]; then
            log "slimlock found and active"
        fi
        return 0;
    fi
    return 1
}

# Notify desired message.
function do_notify() {
    # Only works if X is running.
    if [ is_running_X ]; then
        log "X server is running"
    else
        log "X server is not running";
        return 0;
    fi

    # Notification should not be issued while locked.
    locked && return 0;
    log "Sending notification.";
    
    local secs="";

    # grep finds either Xautolock.notify or Xautolock*notify
    secs="$(xrdb -query | grep -m1 '^Xautolock.notify' | cut -f2)";
    
    test -n "$secs" || secs="30"

    log "Locking in $secs seconds";

    notify-send --urgency="normal" --app-name="mynotify" \
        --icon='/usr/share/icons/Adwaita/48x48/actions/system-lock-screen.png' \
        -- "Screen Lock in " "$secs seconds";
    return 0
}

function do_test() {
    if [ is_running_X ]; then
        log "X is running"
    else
        log "X server down"
    fi
    
    if [ `locked "debug"` ]; then
        log "Screen already locked"
    else
        log "Screen not locked"
    fi
    
    local secs=""
    secs="$(xrdb -query | grep -m1 '^Xautolock.notify' | cut -f2)"
    
    if [ -n "$secs" ]; then
        log "Locking in $secs seconds"
    else
        log "secs not defined"
    fi
}

case "$cmd" in
    notify)
        do_notify
        ;;
    debug)
        do_test
        ;;
    *)
        log "Unrecognized option: $1"
esac
