#!/usr/bin/env bash
#set -eu

if [ -f "$HOME/bin/mylog" ]; then
    . "$HOME/bin/mylog"
fi

# This script is intended to be run as the main dpms off script for this installation.
cmd=${1:-off}

function is_running_X(){
    if ! xset q &>/dev/null; then
        return 1
    fi
    return 0
}

# Is the screen already locked?
function locked() {
    local DebugMode=${1:-no}
    local scrsvApps=('i3lock' 'mate-screensaver-dialog' 'cinnamon-screensaver-pam-helper' 'slimlock' 'gnome-screensaver-dialog' 'xscreensaver')
    local c=0
    for p1 in "${scrsvApps[@]}"; do
        c=$(pgrep -lfc "${p1}")
        if [ $c -gt 0 ] ; then
            if [ "$DebugMode" = "debug" ]; then
                log "${p1} found and active";
                return 0;
            fi
        fi
    done
    return 1;
}

# Return 0 if xset is found.
function xset_ok() {
    [ $(which xset) ] && return 0
    return 1
}

#off the screen if possible.
function do_off() {
    # Only works if X is running.
    is_running_X
    if [ $? -ne 0 ]; then
        log "X server is not running";
        return 0;
    fi
    xset_ok
    if [ $? -eq 0 ]; then
        # if "off" is given as parameter, then spawn a new thread to turn off the screen
        sleep 1 && xset dpms force off &
    else
        log "xset command not found";
    fi
 }

function do_test() {
    is_running_X
    if [ $? -eq 0 ]; then
        log "X is running"
    else
        log "X server down"
    fi
    
    xset_ok
    if [ $? -eq 0 ]; then
        log "xset command can be used";
    else
        log "xset command not found";
    fi

    locked "debug"
    if [ $? -eq 0 ]; then
        log "Screen already locked"
    else
        log "Screen not locked"
    fi
}

case "$cmd" in
    off)
        do_off
        ;;  
    debug)
        do_test
        ;;
    *)
        log "Unrecognized option: $1"
esac
